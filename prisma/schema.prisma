generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//// ENUMS

enum BillingPeriod {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  PENDING
  ACTIVE
  CANCELED
  FAILED
}

enum PaymentProvider {
  MONOBANK
  PIX
  STRIPE
}

enum PaymentStatus {
  CREATED
  SUCCEEDED
  FAILED
}

enum PromoType {
  PERCENT
  FIXED
}

//// MODELS

model User {
  id           String @id @default(uuid()) @db.Uuid
  email        String @unique
  passwordHash String @map("password_hash")
  region       String

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("user")
}

model Plan {
  id                  String   @id @default(uuid()) @db.Uuid
  code                String   @unique
  basePriceMonthly    Decimal  @map("base_price_monthly")
  pricePerSeatMonthly Decimal? @map("price_per_seat_monthly")
  includedApiCalls    Int      @map("included_api_calls")

  subscriptions Subscription[]

  @@map("plan")
}

model PromoCode {
  id        String    @id @default(uuid()) @db.Uuid
  code      String    @unique
  type      PromoType
  value     Decimal
  isActive  Boolean   @default(true) @map("is_active")
  expiresAt DateTime? @map("expires_at")

  subscriptions Subscription[]

  @@map("promo_code")
}

model Subscription {
  id String @id @default(uuid()) @db.Uuid

  userId      String  @map("user_id") @db.Uuid
  planId      String  @map("plan_id") @db.Uuid
  promoCodeId String? @map("promo_code_id") @db.Uuid

  billingPeriod BillingPeriod      @map("billing_period")
  seats         Int
  status        SubscriptionStatus
  provider      PaymentProvider

  priceSubtotal Decimal @map("price_subtotal")
  discountTotal Decimal @map("discount_total")
  priceTotal    Decimal @map("price_total")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User       @relation(fields: [userId], references: [id])
  plan      Plan       @relation(fields: [planId], references: [id])
  promoCode PromoCode? @relation(fields: [promoCodeId], references: [id])
  payments  Payment[]

  @@index([userId], map: "idx_subscription_user_id")
  @@index([planId], map: "idx_subscription_plan_id")
  @@index([promoCodeId], map: "idx_subscription_promo_code_id")
  @@map("subscription")
}

model Payment {
  id String @id @default(uuid()) @db.Uuid

  subscriptionId String          @map("subscription_id") @db.Uuid
  provider       PaymentProvider
  status         PaymentStatus

  amount         Decimal
  currency       String

  providerRef    String? @unique @map("provider_ref")

  idempotencyKey String @unique @map("idempotency_key")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId], map: "idx_payment_subscription_id")
  @@map("payment")
}